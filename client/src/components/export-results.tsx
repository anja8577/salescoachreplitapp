import { useState, useEffect } from "react";
import { Button } from "@/components/ui/button";
import { Share2, Download, Home, User as UserIcon } from "lucide-react";
import { useToast } from "@/hooks/use-toast";
import jsPDF from 'jspdf';
import html2canvas from 'html2canvas';
import type { Step, Substep, Behavior, User } from "@shared/schema";
import logoPath from "@assets/Sales Coach icon 11339b.png";

type StepWithSubsteps = Step & {
  substeps: (Substep & {
    behaviors: Behavior[];
  })[];
};

interface ExportResultsProps {
  steps: StepWithSubsteps[];
  checkedBehaviors: Set<number>;
  totalScore: number;
  user: User; // This is the coachee (person being coached)
  assessmentTitle: string;
  stepScores?: { [stepId: number]: number };
  onSaveAssessment?: () => void;
  assessor?: User; // The coach conducting the assessment
  context?: string; // Assessment context
}

export default function ExportResults({ 
  steps, 
  checkedBehaviors, 
  totalScore, 
  user, 
  assessmentTitle,
  stepScores = {},
  onSaveAssessment,
  assessor,
  context = ''
}: ExportResultsProps) {
  const { toast } = useToast();
  const [isSharing, setIsSharing] = useState(false);
  const [pdfBlob, setPdfBlob] = useState<Blob | null>(null);
  const [keyObservations, setKeyObservations] = useState('');
  const [whatWorkedWell, setWhatWorkedWell] = useState('');
  const [whatCanBeImproved, setWhatCanBeImproved] = useState('');
  const [nextSteps, setNextSteps] = useState('');
  const [isLoadingPreviousData, setIsLoadingPreviousData] = useState(false);

  // Load previous coaching session data when component mounts
  useEffect(() => {
    const loadPreviousCoachingData = async () => {
      if (!user?.id) return;
      
      setIsLoadingPreviousData(true);
      try {
        const response = await fetch(`/api/users/${user.id}/latest-assessment`);
        if (response.ok) {
          const previousAssessment = await response.json();
          
          // Set text from previous session as starting content
          setKeyObservations(previousAssessment.keyObservations || '');
          setWhatWorkedWell(previousAssessment.whatWorkedWell || '');
          setWhatCanBeImproved(previousAssessment.whatCanBeImproved || '');
          setNextSteps(previousAssessment.nextSteps || '');
          
          console.log('Loaded previous coaching session data:', {
            keyObservations: previousAssessment.keyObservations,
            whatWorkedWell: previousAssessment.whatWorkedWell,
            whatCanBeImproved: previousAssessment.whatCanBeImproved,
            nextSteps: previousAssessment.nextSteps
          });
        }
      } catch (error) {
        console.log("No previous coaching session found or error loading data");
      } finally {
        setIsLoadingPreviousData(false);
      }
    };

    loadPreviousCoachingData();
  }, [user?.id]);

  const generateResultsText = () => {
    const stepResults = steps.map(step => {
      const stepScore = step.substeps.reduce((total, substep) => {
        return total + substep.behaviors.reduce((substepTotal, behavior) => {
          if (checkedBehaviors.has(behavior.id)) {
            return substepTotal + behavior.proficiencyLevel;
          }
          return substepTotal;
        }, 0);
      }, 0);

      return `${step.title}: ${stepScore} points`;
    }).join('\n');

    return `SSA Behavior Assessment Results

User: ${user.fullName} (${user.email})
${user.team ? `Team: ${user.team}` : ''}
Assessment: ${assessmentTitle}
Date: ${new Date().toLocaleDateString()}

Total Score: ${totalScore} points

Step Breakdown:
${stepResults}

Generated by SSA Behavior Assessment Tool`;
  };

  const generateHTMLReport = () => {
    const stepLevels = steps.map(step => {
      const manualScore = stepScores[step.id];
      if (manualScore && manualScore > 0) {
        return manualScore;
      }
      
      const stepScore = step.substeps.reduce((total, substep) => {
        return total + substep.behaviors.reduce((substepTotal, behavior) => {
          if (checkedBehaviors.has(behavior.id)) {
            return substepTotal + behavior.proficiencyLevel;
          }
          return substepTotal;
        }, 0);
      }, 0);

      if (stepScore === 0) return 0;
      // Same calculation logic as PDF...
      return stepScore > 15 ? 4 : stepScore > 10 ? 3 : stepScore > 5 ? 2 : 1;
    });

    const currentScore = stepLevels.reduce((sum, level) => sum + level, 0) / steps.length;
    const overallProficiencyLevel = currentScore >= 3.5 ? 'Master' : 
                                   currentScore >= 2.5 ? 'Experienced' : 
                                   currentScore >= 1.5 ? 'Qualified' : 'Learner';

    return `
      <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto;">
        <div style="background: #3B82F6; color: white; padding: 20px; text-align: center;">
          <h1>Selling Skills Assessment Report</h1>
        </div>
        
        <div style="padding: 20px;">
          <h2>Assessment Details</h2>
          <p><strong>Name:</strong> ${user.fullName}</p>
          <p><strong>Email:</strong> ${user.email}</p>
          ${user.team ? `<p><strong>Team:</strong> ${user.team}</p>` : ''}
          <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
          <p><strong>Time:</strong> ${new Date().toLocaleTimeString()}</p>
          <p><strong>Proficiency Level:</strong> ${overallProficiencyLevel}</p>
          
          ${keyObservations ? `<h3>Key Observations</h3><p>${keyObservations}</p>` : ''}
          ${whatWorkedWell ? `<h3>What Worked Well</h3><p>${whatWorkedWell}</p>` : ''}
          ${whatCanBeImproved ? `<h3>What Can Be Improved</h3><p>${whatCanBeImproved}</p>` : ''}
          ${nextSteps ? `<h3>Next Steps</h3><p>${nextSteps}</p>` : ''}
        </div>
      </div>
    `;
  };

  const handleWebShare = async () => {
    setIsSharing(true);
    try {
      // Generate PDF and email content
      const pdf = await generatePDF();
      const htmlReport = generateHTMLReport();
      const emailBody = `Please find below the Selling Skills Assessment report for ${user.fullName}:

${htmlReport}

The complete PDF report has been downloaded to your device for attachment.`;

      if (navigator.share && navigator.canShare) {
        try {
          const pdfBlob = pdf.output('blob');
          const file = new File([pdfBlob], `${assessmentTitle.replace(/[^a-z0-9]/gi, '_')}_assessment.pdf`, {
            type: 'application/pdf',
          });

          if (navigator.canShare({ files: [file] })) {
            await navigator.share({
              title: `${assessmentTitle} - Assessment Results`,
              text: emailBody,
              files: [file],
            });
            toast({
              title: "Shared successfully",
              description: "Assessment PDF has been shared.",
            });
            return;
          }
        } catch (shareError) {
          console.log('File sharing not supported, using email fallback');
        }
      }

      // Fallback to email with HTML content
      const subject = encodeURIComponent(`${assessmentTitle} - Assessment Results`);
      const body = encodeURIComponent(emailBody);
      const mailtoUrl = `mailto:?subject=${subject}&body=${body}`;

      // Download PDF for manual attachment
      pdf.save(`${assessmentTitle.replace(/[^a-z0-9]/gi, '_')}_assessment.pdf`);

      window.open(mailtoUrl, '_blank');

      toast({
        title: "Email prepared",
        description: "PDF downloaded for attachment. Email client opened with HTML message template.",
      });

    } catch (error: any) {
      if (error.name !== 'AbortError') {
        toast({
          title: "Share failed",
          description: "Unable to share results. Please try again.",
          variant: "destructive",
        });
      }
    } finally {
      setIsSharing(false);
    }
  };

  const generatePDF = async () => {
    try {
      const pdf = new jsPDF();

      // Calculate overall score for header
      const stepLevels = steps.map(step => {
        const manualScore = stepScores[step.id];
        if (manualScore && manualScore > 0) {
          return manualScore;
        }
        
        const stepScore = step.substeps.reduce((total, substep) => {
          return total + substep.behaviors.reduce((substepTotal, behavior) => {
            if (checkedBehaviors.has(behavior.id)) {
              return substepTotal + behavior.proficiencyLevel;
            }
            return substepTotal;
          }, 0);
        }, 0);

        if (stepScore === 0) return 0;
        return stepScore > 15 ? 4 : stepScore > 10 ? 3 : stepScore > 5 ? 2 : 1;
      });

      const currentScore = stepLevels.reduce((sum, level) => sum + level, 0) / steps.length;
      const overallProficiencyLevel = currentScore >= 3.5 ? 'Master' : 
                                     currentScore >= 2.5 ? 'Experienced' : 
                                     currentScore >= 1.5 ? 'Qualified' : 'Learner';

      // Header with new design - taller blue box
      pdf.setFillColor(59, 130, 246); // Blue background
      pdf.rect(0, 0, 210, 30, 'F');

      pdf.setTextColor(255, 255, 255);
      pdf.setFontSize(16);
      
      // First row - SalesCoach Report aligned left
      pdf.text('SalesCoach Report', 20, 15);

      // Second row - Coach and Coachee names on left, date/time on right
      pdf.setFontSize(10);
      
      // Format date and time in European format
      const now = new Date();
      const dateEU = now.toLocaleDateString('de-DE');
      const timeEU = now.toLocaleTimeString('de-DE', { hour12: false, hour: '2-digit', minute: '2-digit' });

      // Left side: Coach and Coachee names on same line
      const coachText = assessor ? `Coach: ${assessor.fullName}` : '';
      const coacheeText = `Coachee: ${user.fullName}`;
      pdf.text(coachText, 20, 23);
      pdf.text(coacheeText, 80, 23);
      
      // Right side: Date and time with separator
      const dateTimeText = `${dateEU}  |  ${timeEU}`;
      const dateTimeWidth = pdf.getTextWidth(dateTimeText);
      pdf.text(dateTimeText, 190 - dateTimeWidth, 23);

      let yPosition = 45;

      // Set up new layout: Context box on left, spider graph on right
      const leftColumnX = 20;
      const leftColumnWidth = 70; // Width for context box
      const rightColumnX = 95;    // Start right column for spider graph (moved left)
      const rightColumnWidth = 110; // Wider spider graph

      // Context section - positioned higher and ending above step boxes
      if (context) {
        pdf.setTextColor(0, 0, 0);
        pdf.setFontSize(9);
        pdf.text('Context:', leftColumnX, yPosition - 5);
        
        // Draw grey border box - shorter height to end above step boxes
        pdf.setDrawColor(180, 180, 180);
        pdf.setLineWidth(0.5);
        pdf.rect(leftColumnX, yPosition - 2, leftColumnWidth, 50);
        
        pdf.setFontSize(10);
        const contextLines = pdf.splitTextToSize(context, leftColumnWidth - 5);
        contextLines.forEach((line: string, index: number) => {
          pdf.text(line, leftColumnX + 2, yPosition + 3 + (index * 5));
        });
      }

      // Capture and add spider graph to the right column - wider and starting from header area
      try {
        const spiderElement = document.querySelector('.recharts-wrapper') || document.querySelector('svg');
        if (spiderElement) {
          const canvas = await html2canvas(spiderElement as HTMLElement, {
            backgroundColor: '#ffffff',
            scale: 3, // Higher scale for better quality
            useCORS: true,
          });
          const imgData = canvas.toDataURL('image/png');

          // Make spider graph wider with 90% height and space below
          pdf.addImage(imgData, 'PNG', rightColumnX, 35, rightColumnWidth, 67);
        }
      } catch (error) {
        console.log('Could not capture spider graph:', error);
      }

      yPosition = 110;

      // Steps with colorful headers and level indicators
        steps.forEach((step, stepIndex) => {
          if (yPosition > 250) {
            pdf.addPage();
            yPosition = 20;
          }

          // Step header with color
          const stepColors = [
            [220, 38, 127], [59, 130, 246], [16, 185, 129], [245, 158, 11],
            [139, 69, 19], [168, 85, 247], [239, 68, 68]
          ];
          const color = stepColors[stepIndex % stepColors.length];

          pdf.setFillColor(color[0], color[1], color[2]);
          pdf.rect(15, yPosition - 5, 180, 12, 'F');

          pdf.setTextColor(255, 255, 255);
          pdf.setFontSize(12);
          const stepLevel = stepLevels[stepIndex];
          const stepLevelName = stepLevel >= 3.5 ? 'Master' : 
                               stepLevel >= 2.5 ? 'Experienced' : 
                               stepLevel >= 1.5 ? 'Qualified' : 'Learner';

          pdf.text(`${stepIndex + 1}. ${step.title}`, 20, yPosition + 3);
          pdf.text(stepLevelName, 160, yPosition + 3);

          pdf.setTextColor(0, 0, 0);
          yPosition += 18;

          step.substeps.forEach((substep) => {
            if (yPosition > 270) {
              pdf.addPage();
              yPosition = 20;
            }

            // Substep title without level
            pdf.setFontSize(11);
            pdf.text(`${substep.title}`, 25, yPosition);
            yPosition += 8;

            substep.behaviors.forEach((behavior) => {
              if (yPosition > 275) {
                pdf.addPage();
                yPosition = 20;
              }

              const isChecked = checkedBehaviors.has(behavior.id);

              // Draw checkbox - filled if checked
              pdf.setDrawColor(0, 0, 0);
              pdf.setLineWidth(0.5);
              pdf.rect(30, yPosition - 3, 4, 4);

              if (isChecked) {
                pdf.setFillColor(100, 100, 100); // Grey fill
                pdf.rect(30, yPosition - 3, 4, 4, 'F');
              }

              pdf.setTextColor(0, 0, 0);
              pdf.setFontSize(9);
              
              // Wrap text for long behavior descriptions
              const behaviorText = `L${behavior.proficiencyLevel}: ${behavior.description}`;
              const maxWidth = 150; // Maximum width for text
              const lines = pdf.splitTextToSize(behaviorText, maxWidth);
              
              lines.forEach((line: string, lineIndex: number) => {
                pdf.text(line, 38, yPosition + (lineIndex * 5));
              });
              
              yPosition += lines.length * 5 + 1;
            });
            yPosition += 3;
          });
          yPosition += 5;
        });

        // Always add text input sections with grey borders (even if empty)
        if (yPosition > 220) {
          pdf.addPage();
          yPosition = 20;
        } else {
          yPosition += 10;
        }

        // Key Observations section (always shown)
        pdf.setFontSize(12);
        pdf.setTextColor(0, 0, 0);
        pdf.text('Key Observations:', 20, yPosition);
        yPosition += 8;
        
        // Draw grey border box
        pdf.setDrawColor(180, 180, 180);
        pdf.setLineWidth(0.5);
        pdf.rect(20, yPosition - 2, 170, 20);
        
        if (keyObservations) {
          pdf.setFontSize(10);
          const obsLines = pdf.splitTextToSize(keyObservations, 165);
          obsLines.forEach((line: string, index: number) => {
            pdf.text(line, 22, yPosition + 3 + (index * 5));
          });
        }
        yPosition += 25;

        // What Worked Well section (always shown)
        pdf.setFontSize(12);
        pdf.text('What Worked Well:', 20, yPosition);
        yPosition += 8;
        
        // Draw grey border box
        pdf.rect(20, yPosition - 2, 170, 20);
        
        if (whatWorkedWell) {
          pdf.setFontSize(10);
          const workedLines = pdf.splitTextToSize(whatWorkedWell, 165);
          workedLines.forEach((line: string, index: number) => {
            pdf.text(line, 22, yPosition + 3 + (index * 5));
          });
        }
        yPosition += 25;

        // What Can Be Improved section (always shown)
        pdf.setFontSize(12);
        pdf.text('What Can Be Improved:', 20, yPosition);
        yPosition += 8;
        
        // Draw grey border box
        pdf.rect(20, yPosition - 2, 170, 20);
        
        if (whatCanBeImproved) {
          pdf.setFontSize(10);
          const improvedLines = pdf.splitTextToSize(whatCanBeImproved, 165);
          improvedLines.forEach((line: string, index: number) => {
            pdf.text(line, 22, yPosition + 3 + (index * 5));
          });
        }
        yPosition += 25;

        // Next Steps section (always shown)
        pdf.setFontSize(12);
        pdf.text('Next Steps:', 20, yPosition);
        yPosition += 8;
        
        // Draw grey border box
        pdf.rect(20, yPosition - 2, 170, 20);
        
        if (nextSteps) {
          pdf.setFontSize(10);
          const stepLines = pdf.splitTextToSize(nextSteps, 165);
          stepLines.forEach((line: string, index: number) => {
            pdf.text(line, 22, yPosition + 3 + (index * 5));
          });
        }
        yPosition += 25;

        // Add signature section at the bottom
        if (yPosition > 220) {
          pdf.addPage();
          yPosition = 20;
        } else {
          yPosition += 20;
        }

        // Signature section header
        pdf.setFillColor(240, 240, 240);
        pdf.rect(15, yPosition - 5, 180, 8, 'F');
        pdf.setTextColor(0, 0, 0);
        pdf.setFontSize(12);
        pdf.text('Electronic Signatures', 20, yPosition);
        yPosition += 15;

        // Coach signature field
        if (assessor) {
          pdf.setFontSize(10);
          pdf.text('Coach Signature:', 20, yPosition);
          pdf.setDrawColor(150, 150, 150);
          pdf.setLineWidth(0.5);
          pdf.line(55, yPosition + 2, 100, yPosition + 2);
          pdf.text('Date:', 110, yPosition);
          pdf.line(125, yPosition + 2, 160, yPosition + 2);
          yPosition += 8;
          pdf.setFontSize(8);
          pdf.text(`${assessor.fullName}`, 55, yPosition);
          yPosition += 15;
        }

        // Coachee signature field
        pdf.setFontSize(10);
        pdf.text('Coachee Signature:', 20, yPosition);
        pdf.setDrawColor(150, 150, 150);
        pdf.setLineWidth(0.5);
        pdf.line(55, yPosition + 2, 100, yPosition + 2);
        pdf.text('Date:', 110, yPosition);
        pdf.line(125, yPosition + 2, 160, yPosition + 2);
        yPosition += 8;
        pdf.setFontSize(8);
        pdf.text(`${user.fullName}`, 55, yPosition);

        // Add note about electronic signature
        yPosition += 15;
        pdf.setFontSize(8);
        pdf.setTextColor(100, 100, 100);
        pdf.text('Note: This document supports electronic signatures for digital approval.', 20, yPosition);

      return pdf;
    } catch (error) {
      console.error('PDF generation error:', error);
      throw error;
    }
  };

  const handleDownload = async () => {
    try {
      const pdf = await generatePDF();
      pdf.save(`${assessmentTitle.replace(/[^a-z0-9]/gi, '_')}_assessment.pdf`);

      toast({
        title: "PDF Downloaded",
        description: "Assessment results have been downloaded as PDF.",
      });
    } catch (error) {
      toast({
        title: "Download Error",
        description: "Failed to generate PDF. Please try again.",
        variant: "destructive",
      });
    }
  };

  const handleEmailShare = () => {
    const resultsText = generateResultsText();
    const subject = encodeURIComponent(`${assessmentTitle} - Assessment Results`);
    const body = encodeURIComponent(resultsText);
    const mailtoUrl = `mailto:?subject=${subject}&body=${body}`;

    window.open(mailtoUrl, '_blank');
  };

  const handleHome = () => {
    window.location.href = '/';
  };

  const handleProfile = () => {
    window.location.href = '/profile';
  };

  return (
    <div className="space-y-4">
      {/* Text Input Fields */}
      <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6 space-y-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">Key Observations</label>
          <textarea
            value={keyObservations}
            onChange={(e) => setKeyObservations(e.target.value)}
            className="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            rows={3}
            placeholder="Enter key observations from the assessment..."
          />
        </div>
        
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">What Worked Well</label>
          <textarea
            value={whatWorkedWell}
            onChange={(e) => setWhatWorkedWell(e.target.value)}
            className="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            rows={3}
            placeholder="Highlight what worked well in this coaching session..."
          />
        </div>
        
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">What Can Be Improved</label>
          <textarea
            value={whatCanBeImproved}
            onChange={(e) => setWhatCanBeImproved(e.target.value)}
            className="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            rows={3}
            placeholder="Identify areas for improvement and development..."
          />
        </div>
        
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">Next Steps</label>
          <textarea
            value={nextSteps}
            onChange={(e) => setNextSteps(e.target.value)}
            className="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            rows={3}
            placeholder="Outline the next steps and action items..."
          />
        </div>
      </div>

      {/* Save Assessment Button */}
      {onSaveAssessment && (
        <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6 text-center">
          <button 
            className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-medium transition-colors"
            onClick={onSaveAssessment}
          >
            Save Coaching Session
          </button>
        </div>
      )}

      {/* Export Actions */}
      <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
        <div className="grid grid-cols-4 gap-3">
          <button
            onClick={handleWebShare}
            disabled={isSharing}
            className="flex flex-col items-center justify-center space-y-2 p-3 hover:bg-gray-50 rounded-lg transition-colors"
          >
            <Share2 size={24} className="text-green-600" />
            <span className="text-xs text-gray-600">{isSharing ? "Sharing..." : "Share"}</span>
          </button>

          <button
            onClick={handleDownload}
            className="flex flex-col items-center justify-center space-y-2 p-3 hover:bg-gray-50 rounded-lg transition-colors"
          >
            <Download size={24} className="text-blue-600" />
            <span className="text-xs text-gray-600">Download</span>
          </button>

          <button
            onClick={handleHome}
            className="flex flex-col items-center justify-center space-y-2 p-3 hover:bg-gray-50 rounded-lg transition-colors"
          >
            <Home size={24} className="text-purple-600" />
            <span className="text-xs text-gray-600">Home</span>
          </button>

          <button
            onClick={handleProfile}
            className="flex flex-col items-center justify-center space-y-2 p-3 hover:bg-gray-50 rounded-lg transition-colors"
          >
            <UserIcon size={24} className="text-orange-600" />
            <span className="text-xs text-gray-600">Profile</span>
          </button>
        </div>
      </div>
    </div>
  );
}